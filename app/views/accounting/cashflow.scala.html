@import scala.collection.immutable.Seq

@import models.User
@import models.accounting.Money.CurrencyUnit
@import models.accounting.config.{Account, MoneyReservoir, Category, Template}
@import controllers.helpers.accounting._
@import viewhelpers.Formatting._
@import views.html.accounting.parts._

@(
  accountToReservoirs: Map[Account, Iterable[MoneyReservoir]],
  reservoirToEntries: Map[MoneyReservoir, Seq[CashFlowEntry]],
  numEntriesShownByDefault: Int,
  expandedNumEntries: Int,
  templatesInNavbar: Seq[Template]
)(
  implicit user: User, request: Request[AnyContent], messages: Messages, flash: Flash
)

@extrascript = {
  <script src="@routes.Assets.at("javascripts/cashflow.js")"></script>
}

@Main(Messages("facto.cash-flow"), extrascript, templatesInNavbar = templatesInNavbar, generateToc = true) {
  <h1><i class="icon-money"></i> @Messages("facto.cash-flow")</h1>
  
  @for((account, reservoirs) <- accountToReservoirs) {
    @Panel(
      title = Messages("facto.account-of", account.longName),
      panelClasses = if(account.isMineOrCommon) "" else "hidden other-accounts"
    ) { @* panel content *@

      @for(reservoir <- reservoirs) {
        @viewhelpers.accounting.Table.cachedWithIndexedEntries(
          title = reservoir.name,
          tableTypeIdentifierForCache = s"cachflow_${reservoir.code}",
          tableClasses = "table-cashflow",
          allEntriesLink = (reservoirToEntries(reservoir).size > expandedNumEntries) match {
              case true => Some(controllers.accounting.routes.Views.cashFlowOfSingle(reservoir.code))
              case false => None
            },
          numEntriesShownByDefault = numEntriesShownByDefault,
          colspan = 8,
          entries = reservoirToEntries(reservoir).reverse.take(expandedNumEntries)
        ) { @* table headers *@
          <th>@Messages("facto.payed")</th>
          <th>@Messages("facto.consumed")</th>
          <th>@Messages("facto.beneficiary")</th>
          <th>@Messages("facto.category")</th>
          <th>@Messages("facto.description")</th>
          <th>@Messages("facto.flow") (@reservoir.currency.htmlSymbol)</th>
          <th>@Messages("facto.balance") (@reservoir.currency.htmlSymbol)</th>
          <th>@BalanceCheckAddNewButton(reservoir)</th>
        } { (entry, i) =>  @* table datas *@
          @entry match {
            case entry:RegularEntry => {
              <td>@entry.transactionDates.map(formatDate).mkString(", ")</td>
              <td>@entry.consumedDates.map(formatDate).mkString(", ")</td>
              <td>@entry.beneficiaries.map(_.shorterName).mkString(", ")</td>
              <td>@entry.categories.map(_.name).mkString(", ")</td>
              <td>@DescriptionWithEntryCount(entry)</td>
              <td>@entry.flow.formatFloat</td>
              <td>
                @entry.balance.formatFloat
                @if(entry.balanceVerified) {
                  <i class="fa fa-check fa-fw"></i>
                }
                @if(!entry.balanceVerified && i == 0) {
                  @BalanceCheckConfirmButton(reservoir, entry){ @* contentWhenConfirmed *@
                    <i class="fa fa-check fa-fw"></i>
                  }
                }
              </td>
              <td>@TransactionGroupEditButton(entry.groupId)</td>
            }
            case BalanceCorrection(bc) => {
              <td>@formatDate(bc.checkDate)</td>
              <td colspan="5" style="font-weight: bold;">@Messages("facto.balance-correction"):</td>
              <td>@bc.balance.formatFloat</td>
              <td>@BalanceCheckEditButton(bc)</td>
            }
          }
        }
      }
    }
  }

  @* Unhide other accounts *@
  @if(!reservoirToEntries.filterKeys(!_.owner.isMineOrCommon).isEmpty) {
    @OtherAccounts()
  }
}
